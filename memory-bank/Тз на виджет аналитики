# ТЗ: Виджет аналитики микрозадач

## Цель
Показать аналитику по завершённым микрозадачам за выбранный период с бесконечным скроллом по дням и настраиваемыми таймерами (фильтры по тегам/категориям, дням недели). Данные должны обновляться мгновенно при любых изменениях фильтров/таймеров.

## Источник данных
- База микрозадач (таблица micro_tasks), берём **только завершённые** задачи, независимо от текущего виджета/архива.
- Дата привязки задачи к дню: `created_at` (день создания).

## Период и скролл
- Период задаётся парой дат start/end (границы включены).
- Начальная позиция списка = конец периода (end).
- Бесконечный скролл по дням с шагом 1 день: вверх — к более ранним датам, вниз — к более поздним. Жёстких лимитов нет; подгрузка батчами (пагинация скрыта пользователю).

## Отображение задач по дням
- День → список завершённых задач этого дня.
- Карточка задачи повторяет microTasks, но:
  - нет кнопок старт/стоп, нет архивирования, нет завершить;
  - текст не зачёркнут;
  - задачи всегда завершающие;
  - остаются: название, таймер/потраченное время, кнопка удаления, кнопка редактирования привязанных категорий/тегов (как в microTasks).

## Таймеры (фильтры)
- У таймера свой набор тегов и категорий (категории **без auto**; авто-категории не предлагаются).
- Логика отбора задач для таймера: OR по выбранным тегам/категориям. Задача входит, если содержит хотя бы один выбранный тег ИЛИ хотя бы одну выбранную категорию. Если категория ссылается на тег, она считается самостоятельным фильтром (не добавляет тег автоматически).
- У каждого таймера свой набор дней недели (Пн–Вс чекбоксы, по умолчанию все включены).
- Общий таймер: таймер без фильтров, применяет только период и свои дни недели.
- Управление таймерами (создание/удаление/правка фильтров и дней недели) доступно только внутри этого виджета аналитики.

## Метрики на таймере
- Суммарные часы за выбранный период **после** применения фильтров (период + дни недели + фильтр тегов/категорий).
- Среднее время в день: по включённым дням недели в заданном периоде.
- Процент: доля времени таймера от суммы времени по всем таймерам с их фильтрами и теми же глобальными ограничениями периода/дней (без учёта невыбранных таймеров).

## Обновление данных
- Любое действие (смена периода, изменение таймера/его фильтров/дней, удаление задачи, скролл) обновляет данные сразу, без кнопки Apply.
- Бесконечный скролл лениво подгружает дни, пока пользователь листает.

## Хранение состояния
- Период, набор таймеров и их настройки, выбранные дни недели: сохранять per-user **в БД** (серверное хранение, чтобы настройки были доступны между устройствами/сессиями).

## Вкладки
- **Задачи**: текущий список по дням (описано выше).
- **Графики**: линии по таймерам.
  - Цвет линии = цвет таймера (таймеры можно настраивать по цвету внутри аналитики).
  - Аггрегация по оси X: выбор глобально — день / неделя / месяц. Одна точка = один бакет выбранной гранулярности.
  - Метрика по оси Y: выбор глобально — общее время, среднее время, процент.
  - Процент: доля времени таймера от **суммы времени всех задач за период** (после фильтрации по выбранным дням недели таймера, тегам/категориям, периоду). Общий таймер в графики не включаем.
  - Фильтр дней недели таймера применяется внутри каждого бакета (для недель/месяцев учитываются только отмеченные дни).
  - По оси X пропускаем дни/бакеты, где все выбранные таймеры дали 0 из-за их фильтров дней (пример: один таймер только Сб, другой только Вс → X содержит Сб и Вс).
  - При большом числе точек допускается горизонтальный скролл; графики должны быть адаптивными.
  - Таймзона для всех расчётов и отображения дат/бакетов: **МСК (Europe/Moscow)**.

## Не включено / предположения
- Экспорт/отдельная сводка вне таймеров не требуются (не описано).
- Метрики считаются только по завершённым задачам; активные/архивные незавершённые не участвуют.

